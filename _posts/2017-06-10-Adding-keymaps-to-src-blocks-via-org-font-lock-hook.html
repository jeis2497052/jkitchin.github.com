---
title: Adding keymaps to src blocks via org-font-lock-hook
date: 2017/06/10 15:27:07
updated: 2017/06/10 15:27:07
categories: orgmode,emacs
tags: 
---


<p>
I had an idea to use custom keymaps in src-blocks. For example, you could then use lispy directly in your org-files without entering org-special-edit, or the elpy key-bindings in python blocks. There are other solutions I have seen, e.g. polymode, that claim to do this. You might guess that if they worked, I would not be writing this! There was some nice discussion about this idea on the org-mode mailing list, and Nicolas Goaziou pointed out this might be accomplished with the org-font-lock-hook.
</p>

<p>
You can check out the video here:
</p>
<p>
It was relatively easy to figure out how to do this. Keymaps can be added to regions during font-lock, so I just had to hook into the org-mode font lock system with a function to find the src blocks and add the keymap as a text-property. That took three steps:
</p>

<ol class="org-ol">
<li>Define the keymaps to use. I use an a-list of (language . map) for this.</li>
<li>Define the font-lock function. This will add the keymap properties to src-blocks.</li>
<li>Define a minor mode to toggle this feature on and off.</li>
</ol>

<p>
Here is the definition of the keymaps. Generally I just copy the mode-map I want and then add some things to them. For example sometimes it is still a good idea to jump into the org-special-edit mode. For example, if you try to use a command in a Python block to send the buffer to the repl while in org-mode you are sure to get an error! You might also want to add the C-c C-e export command if you use that a lot. An alternative approach, of course, is to copy the org-map and add additional bindings to it. The choice is up to you.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defcustom</span> <span style="color: #BA36A5;">scimax-src-block-keymaps</span>
  `((<span style="color: #008000;">"ipython"</span> . ,(<span style="color: #0000FF;">let*</span> ((map (copy-keymap elpy-mode-map)))
                    (define-key map (kbd <span style="color: #008000;">"C-c C-c"</span>) 'org-ctrl-c-ctrl-c)
                    (define-key map (kbd <span style="color: #008000;">"C-c '"</span>) 'org-edit-special)
                    map))
    (<span style="color: #008000;">"emacs-lisp"</span> . ,(<span style="color: #0000FF;">let*</span> ((map (copy-keymap lispy-mode-map)))
                       (define-key map (kbd <span style="color: #008000;">"C-c C-c"</span>) 'org-ctrl-c-ctrl-c)
                       (define-key map (kbd <span style="color: #008000;">"C-c '"</span>) 'org-edit-special)
                       map)))
  <span style="color: #036A07;">"alist of custom keymaps for src blocks."</span>)
</pre>
</div>

<p>
Next we define the function that will apply the keymap to each src block. The keymaps are only applied when they are defined in the variable above. This function is derived from org-fontify-meta-lines-and-blocks-1.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">scimax-add-keymap-to-src-blocks</span> (limit)
  <span style="color: #036A07;">"Add keymaps to src-blocks defined in `</span><span style="color: #D0372D;">scimax-src-block-keymaps</span><span style="color: #036A07;">'."</span>
  (<span style="color: #0000FF;">let</span> ((case-fold-search t))
    (<span style="color: #0000FF;">when</span> (re-search-forward
           <span style="color: #008000;">"^</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">[ \t]*#</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">\\+[a-zA-Z]+:?</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;"> </span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">|</span><span style="color: #008000;">$</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">_</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">[a-zA-Z]+</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">?</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">[ \t]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">[</span><span style="color: #008000;">^</span><span style="color: #008000;"> \t\n]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">[ \t]*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">(</span><span style="color: #008000;">.*</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000; font-weight: bold;">\\</span><span style="color: #008000; font-weight: bold;">)</span><span style="color: #008000;">"</span>
           limit t)
      (<span style="color: #0000FF;">let</span> ((beg (match-beginning 0))
            (lang (match-string 7))
            (dc3 (downcase (match-string 3)))
            end)
        (<span style="color: #0000FF;">cond</span>
         ((<span style="color: #0000FF;">and</span> (match-end 4) (equal dc3 <span style="color: #008000;">"+begin"</span>))
          (<span style="color: #0000FF;">when</span> (re-search-forward
                 (concat <span style="color: #008000;">"^[ \t]*#\\+end"</span> (match-string 4) <span style="color: #008000;">"\\&gt;.*"</span>)
                 nil t) <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">on purpose, we look further than LIMIT</span>
            (<span style="color: #0000FF;">setq</span> end (min (point-max) (match-end 0)))
            (add-text-properties
             beg end '(font-lock-fontified t font-lock-multiline t))

            <span style="color: #8D8D84;">;; </span><span style="color: #8D8D84; font-style: italic;">Add keymap</span>
            (<span style="color: #0000FF;">when</span> (assoc (org-no-properties lang) scimax-src-block-keymaps)
              (add-text-properties
               beg end `(local-map ,(cdr (assoc
                                          (org-no-properties lang)
                                          scimax-src-block-keymaps)))))
            t)))))))
</pre>
</div>

<p>
Here we create an advice to trick any functions that need to know the major mode. We only apply the spoof if we are in org-mode and in a src block though. Otherwise we call the original function. So far lispy&#x2013;eval is the only function I have needed it for. This might be a general strategy though to do other things like narrow to the src-block, or even go into special edit mode temporarily if there are commands that require it.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">defun</span> <span style="color: #006699;">scimax-spoof-mode</span> (orig-func <span style="color: #6434A3;">&amp;rest</span> args)
  <span style="color: #036A07;">"Advice function to spoof commands in org-mode src blocks.</span>
<span style="color: #036A07;">It is for commands that depend on the major mode. One example is</span>
<span style="color: #036A07;">`</span><span style="color: #D0372D;">lispy--eval</span><span style="color: #036A07;">'."</span>
  (<span style="color: #0000FF;">if</span> (org-in-src-block-p)
      (<span style="color: #0000FF;">let</span> ((major-mode (intern (format <span style="color: #008000;">"%s-mode"</span> (first (org-babel-get-src-block-info))))))
        (apply orig-func args))
    (apply orig-func args)))
</pre>
</div>

<p>
We define a minor mode so we can toggle this on and off. Here we add the function to the org-font-lock-hook and advise the lispy&#x2013;eval function. I had to add the font-lock-function to the end of the org-font-lock hook for some reason, and also add local-map as an extra-managed property so it would be removed when we toggle it off.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #0000FF;">define-minor-mode</span> <span style="color: #006699;">scimax-src-keymap-mode</span>
  <span style="color: #036A07;">"Minor mode to add mode keymaps to src-blocks."</span>
  <span style="color: #006FE0;">:init-value</span> nil
  (<span style="color: #0000FF;">if</span> scimax-src-keymap-mode
      (<span style="color: #0000FF;">progn</span>
        (add-hook 'org-font-lock-hook #'scimax-add-keymap-to-src-blocks t)
        (add-to-list 'font-lock-extra-managed-props 'local-map)
        (advice-add 'lispy--eval <span style="color: #006FE0;">:around</span> 'scimax-spoof-mode))
    (remove-hook 'org-font-lock-hook #'scimax-add-keymap-to-src-blocks)
    (advice-remove 'lispy--eval 'scimax-spoof-mode))
  (font-lock-fontify-buffer))
</pre>
</div>

<p>
That is it! I am pretty sure this is a good idea. It helps a lot when you are writing a lot of short code blocks and near equal amounts of text (like in this blog post). It also helps write the code since many things like indentation, parentheses, etc. are automatically handled. That is what I used to go into special-edit mode all the time for!
</p>

<p>
I have not used this long enough to know if it causes any other surprises. If you try it and find any, leave a comment!
</p>
<p>Copyright (C) 2017 by John Kitchin. See the <a href="/copying.html">License</a> for information about copying.<p>
<p><a href="/org/2017/06/10/Adding-keymaps-to-src-blocks-via-org-font-lock-hook.org">org-mode source</a></p>
<p>Org-mode version = 9.0.7</p>